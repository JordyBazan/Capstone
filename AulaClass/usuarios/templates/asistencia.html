{% extends "base.html" %}
{% load static dict_extras %}

{% block title %}AulaClass - Asistencia{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/asistencia.css' %}">
{% endblock %}

{% block content %}
<div class="main-container">

    <h2 class="sectionTitle">Asistencia: {{ curso.nombre }}</h2>
    <p class="hint">Gestiona la asistencia diaria de los alumnos.</p>

    <div class="controls-wrapper">
        
        <div class="page-switch">
            <a href="?page=1{% if fecha_filtrada %}&fecha={{ fecha_filtrada }}{% endif %}"
               class="page-btn {% if page == '1' %}active{% endif %}">
               Registrar asistencia
            </a>
            <a href="?page=2{% if fecha_filtrada %}&fecha={{ fecha_filtrada }}{% endif %}" 
               class="page-btn {% if page == '2' %}active{% endif %}">
               Ver histórico
            </a>
        </div>

        <form method="get" style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="hidden" name="page" value="{{ page }}">
            <label for="fecha_selector" style="font-weight:600; color:#64748b;">Fecha:</label>
            <input type="date" id="fecha_selector" name="fecha" 
                   class="date-picker"
                   value="{{ fecha_filtrada|default:'' }}" 
                   onchange="this.form.submit()">
        </form>
    </div>

    {% if page == '1' %}
    
    <form method="POST" id="form-asistencia">
      {% csrf_token %}
      <input type="hidden" name="fecha" value="{{ fecha_filtrada }}">

      <div class="table-responsive">
          <table class="asistencia-tabla">
            <thead>
              <tr>
                <th style="width: 50px;">#</th>
                <th>Alumno</th>
                <th>RUT</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for alumno in alumnos %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><strong>{{ alumno.apellidos }}</strong>, {{ alumno.nombres }}</td>
                <td style="color: #64748b; font-size: 0.9rem;">{{ alumno.rut }}</td>
                <td>
                  <div class="radio-group">
                    
                    <input type="radio" id="p_{{ alumno.id }}" name="estado_{{ alumno.id }}" value="Presente"
                           {% if estados|get_item:alumno.id == "Presente" or not estados|get_item:alumno.id %}checked{% endif %}>
                    <label for="p_{{ alumno.id }}">Presente</label>

                    <input type="radio" id="a_{{ alumno.id }}" name="estado_{{ alumno.id }}" value="Ausente"
                           {% if estados|get_item:alumno.id == "Ausente" %}checked{% endif %}>
                    <label for="a_{{ alumno.id }}">Ausente</label>

                    <input type="radio" id="j_{{ alumno.id }}" name="estado_{{ alumno.id }}" value="Justificado"
                           {% if estados|get_item:alumno.id == "Justificado" %}checked{% endif %}>
                    <label for="j_{{ alumno.id }}">Justificado.</label>

                  </div>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="4" style="text-align:center; padding: 2rem;">No hay alumnos en este curso.</td></tr>
              {% endfor %}
            </tbody>
          </table>
      </div>

      <div class="bottom-actions">
          <button type="submit" class="btn-save-main">
              Guardar asistencia
          </button>
      </div>





      



    </form>
    
    {% elif page == '2' %}
       <div style="padding: 2rem; text-align: center; color: #64748b; background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
           Vista histórica.
       </div>
    {% endif %}

</div>
{% endblock %}