{% extends "base.html" %}
{% load static %}

{% block title %}AulaTrack - Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="filter-bar">
  <form method="get">
    <label for="ordenar">Ordenar por:</label>
    <select name="ordenar" id="ordenar" onchange="this.form.submit()">
      <option value="basico_asc" {% if request.GET.ordenar == 'basico_asc' or not request.GET.ordenar %}selected{% endif %}>
        Básico (1° → 8°)
      </option>
      <option value="basico_desc" {% if request.GET.ordenar == 'basico_desc' %}selected{% endif %}>
        Básico (8° → 1°)
      </option>
      <option value="nombre_asc" {% if request.GET.ordenar == 'nombre_asc' %}selected{% endif %}>
        Nombre (A → Z)
      </option>
    </select>
  </form>

  {% if user.role == 'utp' %}
    <a class="topCta" href="{% url 'usuarios:crear_curso' %}?from=home">+ Nuevo curso</a>
  {% endif %}
</div>

{% if user.role == 'docente' %}
  <div class="sectionTitle">Mi Curso como Profesor Jefe</div>
  {% if curso_profesor_jefe %}
    <div class="courses">
      <article class="courseCard is-mi-curso" tabindex="0">
        <span class="badge">{{ curso_profesor_jefe.año }}</span>
        <span class="badge-mi-curso">Profesor Jefe</span>

        <div class="title">{{ curso_profesor_jefe.nombre }}</div>
        <div class="meta">Aula {{ curso_profesor_jefe.sala }}</div>

        <div class="meta"><strong>Asignaturas del curso:</strong></div>
        <div class="chips-container">
          {% for a in curso_profesor_jefe.asignaturas.all %}
            <span class="chip">{{ a.nombre }}</span>
          {% empty %}
            <span class="muted">Sin asignaturas asignadas</span>
          {% endfor %}
        </div>

        <div class="meta total-alumnos">
          <strong>Total de alumnos:</strong> {{ curso_profesor_jefe.alumno_set.count }}
        </div>

        <div class="actions">
          <a href="{% url 'usuarios:curso' curso_profesor_jefe.id %}" class="btn btn-primary">Entrar</a>
        </div>
      </article>
    </div>
  {% else %}
    <p class="muted">No eres profesor jefe de ningún curso.</p>
  {% endif %}

  <div class="divider"></div>

  <div class="sectionTitle">Cursos donde Dictas Asignaturas</div>
  {% if cursos_docente %}
    <div class="courses">
      {% for c in cursos_docente %}
        {% if c.profesor_jefe_id != user.id %}
          <article class="courseCard" tabindex="0">
            <span class="badge">{{ c.año }}</span>
            <div class="title">{{ c.nombre }}</div>
            <div class="meta">Aula {{ c.sala }}</div>

            <div class="meta"><strong>Asignaturas a tu cargo:</strong></div>
            <div class="chips-container">
              {% for a in c.asignaturas.all %}
                {% if a.profesor_id == user.id %}
                  <span class="chip chip-docente">{{ a.nombre }}</span>
                {% endif %}
              {% empty %}
                <span class="muted">Sin asignaturas</span>
              {% endfor %}
            </div>

            <div class="actions">
              <a href="{% url 'usuarios:curso' c.id %}" class="btn btn-primary">Entrar</a>
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">No dictas asignaturas actualmente.</p>
  {% endif %}
{% endif %}

{% if user.role == 'utp' %}
  <div class="sectionTitle">Todos los Cursos</div>
  <p class="hint">Vista de UTP: gestión de todos los cursos</p>

  <div class="courses">
    {% if cursos_todos %}
      {% for curso in cursos_todos %}
        <article class="courseCard" tabindex="0">
          <span class="badge">{{ curso.año }}</span>
          <div class="title">{{ curso.nombre }}</div>
          <div class="meta">Aula {{ curso.sala }}</div>
          <div class="meta">
            Profesor Jefe:
            {% if curso.profesor_jefe %}
              {{ curso.profesor_jefe.username }}
            {% else %}
              Sin asignar
            {% endif %}
          </div>

          <div class="actions">
            <a href="{% url 'usuarios:curso' curso.id %}" class="btn btn-primary">Entrar</a>
            <a href="{% url 'usuarios:curso_editar' curso.id %}?from=home" class="btn btn-ghost">Editar</a>
            <form method="post" action="{% url 'usuarios:curso_eliminar' curso.id %}?from=home"
                  style="display:inline;"
                  onsubmit="return confirm('¿Eliminar el curso «{{ curso.nombre }}»? Esta acción no se puede deshacer.');">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="muted">No hay cursos creados.</p>
    {% endif %}
  </div>
{% endif %}

{% if not user.role %}
  <div class="no-role" style="margin-top: 20px; text-align:center;">
    <div class="sectionTitle">Sin Rol Asignado</div>
    <p class="muted">No tienes un rol asignado aún. Contacta al administrador del sistema.</p>
  </div>
{% endif %}
{% endblock %}
