{% extends "base.html" %}
{% load static %}

{% block title %}AulaTrack - Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="filter-bar">
  <form method="get">
    <label for="ordenar">Ordenar por:</label>
    <select name="ordenar" id="ordenar" onchange="this.form.submit()">
      <option value="basico_asc" {% if request.GET.ordenar == 'basico_asc' or not request.GET.ordenar %}selected{% endif %}>
        Básico (1° → 8°)
      </option>
      <option value="basico_desc" {% if request.GET.ordenar == 'basico_desc' %}selected{% endif %}>
        Básico (8° → 1°)
      </option>
      <option value="nombre_asc" {% if request.GET.ordenar == 'nombre_asc' %}selected{% endif %}>
        Nombre (A → Z)
      </option>
    </select>
  </form>

  {% if user.role == 'utp' %}
    <a class="topCta" href="{% url 'usuarios:crear_curso' %}?from=home">+ Nuevo curso</a>
  {% endif %}
</div>

<!-- ============================ -->
<!-- DOCENTE - MIS CURSOS -->
<!-- ============================ -->
{% if user.role == 'docente' %}
  <div class="sectionTitle">Mis Cursos Asignados</div>
  <p class="hint">Cursos donde eres profesor jefe o dictas alguna asignatura.</p>

  <div class="courses">
    {% if cursos_docente %}
      {% for c in cursos_docente %}
        <article class="courseCard {% if c.profesor_jefe_id == user.id %}is-mi-curso{% endif %}" tabindex="0">
          <span class="badge">{{ c.año }}</span>

          {% if c.profesor_jefe_id == user.id %}
            <span class="badge-mi-curso" aria-label="Eres profesor jefe de este curso">Profesor Jefe</span>
          {% endif %}

          <div class="title">{{ c.nombre }}</div>
          <div class="meta">Aula {{ c.sala }}</div>

          <div class="meta">Profesor Jefe:
            {% if c.profesor_jefe %}
              {{ c.profesor_jefe.username }}{% if c.profesor_jefe_id == user.id %} (tú){% endif %}
            {% else %}
              Sin asignar
            {% endif %}
          </div>

          <!-- Lista de asignaturas a su cargo -->
          <div class="meta" style="margin-top: 8px;">
            <strong>Asignaturas a tu cargo:</strong>
            <div style="margin-top: 4px;">
              {% for a in c.asignaturas.all %}
                {% if a.profesor_id == user.id %}
                  <span class="chip">{{ a.nombre }}</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="actions">
            <a href="{% url 'usuarios:curso' c.id %}" class="btn btn-primary">Entrar</a>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="muted">No tienes cursos asignados.</p>
    {% endif %}
  </div>
{% endif %}

<!-- ============================ -->
<!-- UTP - TODOS LOS CURSOS -->
<!-- ============================ -->
{% if user.role == 'utp' %}
  <div class="sectionTitle">Todos los cursos</div>
  <p class="hint">Vista de UTP: gestión de todos los cursos</p>

  <div class="courses">
    {% if cursos_todos %}
      {% for curso in cursos_todos %}
        <article class="courseCard" tabindex="0">
          <span class="badge">{{ curso.año }}</span>
          <div class="title">{{ curso.nombre }}</div>
          <div class="meta">Aula {{ curso.sala }}</div>
          <div class="meta">Profesor Jefe:
            {% if curso.profesor_jefe %}
              {{ curso.profesor_jefe.username }}
            {% else %}
              Sin asignar
            {% endif %}
          </div>

          <div class="actions">
            <a href="{% url 'usuarios:curso' curso.id %}" class="btn btn-primary">Entrar</a>
            <a href="{% url 'usuarios:curso_editar' curso.id %}?from=home" class="btn btn-ghost">Editar</a>
            <form method="post" action="{% url 'usuarios:curso_eliminar' curso.id %}?from=home"
                  style="display:inline;"
                  onsubmit="return confirm('¿Estás seguro de que deseas eliminar el curso «{{ curso.nombre }}»? Esta acción no se puede deshacer.');">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="muted">No hay cursos creados.</p>
    {% endif %}
  </div>
{% endif %}

<!-- ============================ -->
<!-- SIN ROL -->
<!-- ============================ -->
{% if not user.role %}
  <div class="no-role" style="margin-top: 20px; text-align:center;">
    <div class="sectionTitle">Sin Rol Asignado</div>
    <p class="muted">No tienes un rol asignado aún. Contacta al administrador del sistema para que te asigne uno.</p>
  </div>
{% endif %}
{% endblock %}
