{% extends "base.html" %}
{% load static %}

{% block title %}Histórico de Asistencia - {{ curso.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/asistencia.css' %}">

{% endblock %}

{% block content %}
<h2 class="sectionTitle">Histórico de Asistencia - {{ curso.nombre }}</h2>
<p class="hint">Revisión de asistencia pasada</p>

<div class="page-switch">
  <a href="{% url 'usuarios:asistencia' curso.id %}?page=1" class="page-btn">Registrar asistencia</a>
  <a href="{% url 'usuarios:asistencia' curso.id %}?page=2" class="page-btn active">Ver histórico</a>
</div>

<!-- FILTRO -->
<div class="filter-bar">
  <form method="get">
    <input type="hidden" name="page" value="2">
    <label for="fecha">Filtrar por fecha:</label>
    <input type="date" id="fecha" name="fecha" value="{{ fecha_filtrada|default_if_none:'' }}">
    <button type="submit">Filtrar</button>

    {% if fecha_filtrada %}
      <a href="{% url 'usuarios:asistencia' curso.id %}?page=2" class="reset-btn">Ver todos los días</a>
    {% endif %}
  </form>
</div>

<div class="divider"></div>

{% for dia in asistencia_por_dia %}
  <div class="asistencia-card">
    <h3>{{ dia.fecha }}</h3>

    <p>
      <b>Presentes:</b> {{ dia.presentes }}/{{ dia.total }} |
      <b>Asistencia:</b> {{ dia.porcentaje }}%
    </p>

    <a href="{% url 'usuarios:asistencia' curso.id %}?page=1&fecha={{ dia.fecha|date:'Y-m-d' }}"
       class="page-btn" style="margin-bottom: .5rem; display:inline-block;">
      Editar este día
    </a>

    <table class="asistencia-tabla">
      <thead>
        <tr><th>Alumno</th><th>Estado</th></tr>
      </thead>
      <tbody>
        {% for a in dia.registros %}
        <tr
          {% if a.estado|lower == 'presente' %}
            style="color:#16a34a;"
          {% elif a.estado|lower == 'ausente' %}
            style="color:#dc2626;"
          {% else %}
            style="color:#facc15;"
          {% endif %}
        >
          <td>{{ a.alumno.nombres }} {{ a.alumno.apellidos }}</td>
          <td><b>{{ a.estado }}</b></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% empty %}
  <p>No hay registros de asistencia anteriores.</p>
{% endfor %}

{% endblock %}