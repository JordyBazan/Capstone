{% extends "base.html" %}
{% block title %}Historial de acciones{% endblock %}
{% block content %}

<main style="max-width:1000px;margin:auto;">
  <h1>Historial de acciones (Django Admin)</h1>

  <form method="get" style="margin-bottom:1rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
    <select name="usuario">
      <option value="">Todos los usuarios</option>
      {% for u in usuarios %}
        <option value="{{ u.id }}" {% if u.id == usuario_filtrado %}selected{% endif %}>
          {{ u.get_full_name|default:u.username }}
        </option>
      {% endfor %}
    </select>

    <select name="accion">
      <option value="">Todas las acciones</option>
      <option value="1" {% if accion_filtrada == '1' %}selected{% endif %}>Creación</option>
      <option value="2" {% if accion_filtrada == '2' %}selected{% endif %}>Edición</option>
      <option value="3" {% if accion_filtrada == '3' %}selected{% endif %}>Eliminación</option>
    </select>

    <select name="modelo">
      <option value="">Todos los modelos</option>
      {% for m in modelos %}
        <option value="{{ m }}" {% if m == modelo_filtrado %}selected{% endif %}>{{ m|capfirst }}</option>
      {% endfor %}
    </select>

    <button type="submit" class="btn primary">Filtrar</button>
    <a href="{% url 'usuarios:historial_admin' %}" class="btn">Limpiar</a>
  </form>

  <table style="width:100%;border-collapse:collapse;">
    <thead>
      <tr style="background:#f0f0f0;text-align:left;">
        <th style="padding:.5rem;border:1px solid #ddd;">Fecha</th>
        <th style="padding:.5rem;border:1px solid #ddd;">Usuario</th>
        <th style="padding:.5rem;border:1px solid #ddd;">Acción</th>
        <th style="padding:.5rem;border:1px solid #ddd;">Modelo</th>
        <th style="padding:.5rem;border:1px solid #ddd;">Objeto</th>
        <th style="padding:.5rem;border:1px solid #ddd;">Detalle</th>
      </tr>
    </thead>
    <tbody>
      {% for log in log_entries %}
        <tr>
          <td style="padding:.4rem;border:1px solid #ddd;">{{ log.action_time|date:"d/m/Y H:i" }}</td>
          <td style="padding:.4rem;border:1px solid #ddd;">{{ log.user.get_full_name|default:log.user.username }}</td>
          <td style="padding:.4rem;border:1px solid #ddd;">
            {% if log.action_flag == 1 %}Creación
            {% elif log.action_flag == 2 %}Edición
            {% elif log.action_flag == 3 %}Eliminación
            {% else %}Otro{% endif %}
          </td>
          <td style="padding:.4rem;border:1px solid #ddd;">{{ log.content_type.model|capfirst }}</td>
          <td style="padding:.4rem;border:1px solid #ddd;">{{ log.object_repr }}</td>
          <td style="padding:.4rem;border:1px solid #ddd;">{{ log.change_message }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="6" style="text-align:center;padding:1rem;">No hay registros.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</main>
{% endblock %}
