{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión Académica - AulaTrack{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cursos_lista.css' %}">
{% endblock %}

{% block content %}

<div class="dashboard-header">
    <div class="header-top">
        <div>
            <h1>Gestión Académica</h1>
            <p class="hint">Panel de administración</p>
        </div>
        
        <nav class="nav-tabs">
            <a class="nav-tab {% if page == '1' %}active{% endif %}" href="?page=1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Cursos
            </a>
            <a class="nav-tab {% if page == '2' %}active{% endif %}" href="?page=2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                Asignaturas
            </a>
            <a class="nav-tab {% if page == '3' %}active{% endif %}" href="?page=3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                Alumnos
            </a>
        </nav>
    </div>

    <div class="stats-grid">
        {% if page == '1' %}
            <div class="stat-card"><span class="stat-title">Total Cursos</span><span class="stat-value">{{ cursos|length }}</span></div>
        {% elif page == '2' %}
            <div class="stat-card"><span class="stat-title">Total Asignaturas</span><span class="stat-value">{{ total_asignaturas }}</span></div>
            <div class="stat-card"><span class="stat-title">Sin Profesor</span><span class="stat-value" style="color: var(--danger);">{{ total_sin_profesor }}</span></div>
        {% elif page == '3' %}
             <div class="stat-card"><span class="stat-title">Total Alumnos</span><span class="stat-value">{{ alumnos|length }}</span></div>
        {% endif %}
    </div>
</div>

{% if page == '1' %}
<div class="toolbar">
    <div class="filters-group">
        <div class="search-box">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            <input type="text" id="tableSearch" class="control-input search-input" placeholder="Buscar curso...">
        </div>
    </div>
    <a class="btn-action" href="{% url 'usuarios:crear_curso' %}?from=cursos_lista">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Crear Curso
    </a>
</div>

<div class="table-container">
    <table class="pro-table" id="dataTable">
        <thead>
            <tr>
                <th class="col-idx sortable" data-type="number">#</th>
                <th class="sortable">Nombre</th>
                <th class="hide-mobile sortable">Sala</th>
                <th>Asignaturas</th> 
                <th class="sortable">Profesor Jefe</th>
                <th class="hide-mobile sortable" data-type="number" style="text-align:center;">Alumnos</th>
                <th class="col-actions">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for c in cursos %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td><strong>{{ c.nombre }}</strong><div style="font-size: 0.8rem; color: #6b7280;">Año {{ c.año }}</div></td>
                <td class="hide-mobile">{{ c.sala|default:"-" }}</td>
                
                <td style="max-width: 350px;">
                    <div class="chip-wrapper">
                        {% for a in c.asignaturas.all %}
                            <span class="pro-chip" title="Docente: {{ a.profesor.get_full_name|default:a.profesor.username|default:'Sin asignar' }}">
                                <a href="{% url 'usuarios:asignatura_editar' a.id %}">{{ a.nombre }}</a>
                                <form method="post" action="{% url 'usuarios:curso_quitar_asignatura' c.id a.id %}" class="js-delete-form" data-confirm="¿Quitar «{{ a.nombre }}» del curso?" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" aria-label="Quitar">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </form>
                            </span>
                        {% empty %}
                            <span style="color: var(--text-muted); font-size: 0.85rem; font-style: italic;">— Sin asignaturas —</span>
                        {% endfor %}
                    </div>
                </td>

                <td>
                    <form method="post" action="{% url 'usuarios:asignar_profesor_jefe' %}" class="inline-pj-form">
                        {% csrf_token %}
                        <input type="hidden" name="curso_id" value="{{ c.id }}">
                        <select name="profesor_jefe" class="control-input" style="height:32px; padding:0 8px; font-size:0.85rem; width:auto; max-width:160px;">
                            <option value="">— Sin asignar —</option>
                            {% for d in docentes %}
                                <option value="{{ d.id }}" {% if c.profesor_jefe_id == d.id %}selected{% endif %}>{{ d.get_full_name|default:d.username }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn-save-mini" title="Guardar">OK</button>
                    </form>
                </td>
                <td class="hide-mobile" style="text-align:center;">
                    <span class="info-chip">{{ c.num_alumnos }}</span>
                </td>
                <td class="col-actions">
                    <div class="action-group">
                        <a href="{% url 'usuarios:asignar_asignaturas_curso' c.id %}" class="btn-icon" title="Asignar Asignaturas"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></a>
                        <a href="{% url 'usuarios:curso_editar' c.id %}" class="btn-icon" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></a>
                        <form method="post" action="{% url 'usuarios:curso_eliminar' c.id %}" class="js-delete-form" data-confirm="¿Eliminar curso {{ c.nombre }}?">
                            {% csrf_token %}
                            <button type="submit" class="btn-icon danger" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </form>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">No hay cursos registrados.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="emptyState" class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <h3>No se encontraron cursos</h3>
    </div>
</div>
{% endif %}

{% if page == '2' %}
<div class="global-assign-box">
    <div class="global-header">
        <h3>Asignación Masiva de Docentes</h3>
        <p>Asigna un profesor a todas las asignaturas con el mismo nombre en todos los cursos a la vez.</p>
    </div>
    <form method="post" action="{% url 'usuarios:asignar_docente_global' %}" onsubmit="return confirm('¿Confirmar asignación masiva?');" style="display:flex; gap:1rem; flex-wrap:wrap;">
        {% csrf_token %}
        <select name="nombre_asignatura" class="control-input" style="flex:1;" required>
            <option value="">Seleccionar Asignatura...</option>
            {% for nombre in nombres_asignaturas %}
                <option value="{{ nombre }}">{{ nombre }}</option>
            {% endfor %}
        </select>
        <select name="docente_id" class="control-input" style="flex:1;" required>
            <option value="">Seleccionar Docente...</option>
            {% for d in docentes %}
                <option value="{{ d.id }}">{{ d.get_full_name|default:d.username }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn-action">Aplicar a Todos</button>
    </form>
</div>

<div class="toolbar">
    <form method="get" class="filters-group">
        <input type="hidden" name="page" value="2">
        <div class="search-box" style="flex:2;">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            <input type="text" id="tableSearch" class="control-input search-input" placeholder="Buscar asignatura, docente...">
        </div>
        <select name="curso" onchange="this.form.submit()" class="control-input" style="flex:1;">
            <option value="">Todos los Cursos</option>
            {% for c in cursos %}
                <option value="{{ c.id }}" {% if curso_id|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>{{ c.nombre }}</option>
            {% endfor %}
        </select>
        <select name="nombre_asignatura" onchange="this.form.submit()" class="control-input" style="flex:1;">
            <option value="">Todas las Materias</option>
            {% for nombre in nombres_asignaturas %}
                <option value="{{ nombre }}" {% if nombre_asignatura == nombre %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
        </select>
    </form>
    <a class="btn-action" href="{% url 'usuarios:crear_asignatura' %}">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Nueva
    </a>
</div>

<div class="table-container">
    <table class="pro-table" id="dataTable">
        <thead>
            <tr>
                <th class="sortable">Asignatura</th>
                <th class="sortable">Curso</th>
                <th class="sortable">Docente a Cargo</th>
                <th class="col-actions">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for a in asignaturas %}
            <tr>
                <td><strong>{{ a.nombre }}</strong></td>
                <td><span class="info-chip">{{ a.curso.nombre }}</span></td>
                <td>
                    {% if a.profesor %}
                        {{ a.profesor.get_full_name|default:a.profesor.username }}
                    {% else %}
                        <span style="color: var(--danger);">Sin asignar</span>
                    {% endif %}
                </td>
                <td class="col-actions">
                    <div class="action-group">
                        <a href="{% url 'usuarios:asignatura_editar' a.id %}" class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></a>
                        <form method="post" action="{% url 'usuarios:asignatura_eliminar' a.id %}" class="js-delete-form">
                            {% csrf_token %}
                            <button type="submit" class="btn-icon danger"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="emptyState" class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <h3>No se encontraron asignaturas</h3>
    </div>
</div>
{% endif %}

{% if page == '3' %}
<div class="toolbar">
    <form method="get" class="filters-group">
        <input type="hidden" name="page" value="3">
        <div class="search-box" style="flex:2;">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            <input type="text" id="tableSearch" class="control-input search-input" placeholder="Buscar por nombre o RUT...">
        </div>
        <select name="curso" onchange="this.form.submit()" class="control-input" style="flex:1;">
            <option value="">Todos los Cursos</option>
            {% for c in cursos_alumno %}
                <option value="{{ c.id }}" {% if curso_seleccionado == c.id %}selected{% endif %}>{{ c.nombre }}</option>
            {% endfor %}
        </select>
    </form>

    <a class="btn-action" href="{% url 'usuarios:agregar_alumno' %}">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        Nuevo Alumno
    </a>
</div>

<div class="table-container">
    <table class="pro-table" id="dataTable">
        <thead>
            <tr>
                <th class="col-idx sortable" data-type="number">#</th>
                <th class="sortable">RUT</th>
                <th class="sortable">Nombre Completo</th>
                <th class="sortable">Curso</th>
                <th class="col-actions">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for alumno in alumnos %}
            <tr>
                <td class="col-idx">{{ forloop.counter }}</td>
                <td style="font-family: monospace; font-weight:bold;">{{ alumno.rut }}</td>
                <td><strong>{{ alumno.apellidos }}</strong>, {{ alumno.nombres }}</td>
                <td>
                    {% if alumno.curso %}
                        <span class="info-chip">{{ alumno.curso.nombre }}</span>
                    {% else %}
                        <span style="color: var(--text-muted);">-</span>
                    {% endif %}
                </td>
                <td class="col-actions">
                    <div class="action-group">
                        <a href="{% url 'usuarios:reporte_alumno' alumno.id %}" class="btn-icon" title="Reporte PDF" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></a>
                        <a href="{% url 'usuarios:editar_alumno' alumno.id %}" class="btn-icon" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></a>
                        <form method="post" action="{% url 'usuarios:eliminar_alumno' alumno.id %}" class="js-delete-form">
                            {% csrf_token %}
                            <button type="submit" class="btn-icon danger"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="emptyState" class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <h3>No se encontraron alumnos</h3>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Confirmación Eliminar
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.js-delete-form button');
        if (btn) {
            const form = btn.closest('form');
            const msg = form.getAttribute('data-confirm') || '¿Seguro que deseas eliminar este registro?';
            if (!confirm(msg)) e.preventDefault();
        }
    });

    // Buscador + Empty State
    const searchInput = document.getElementById('tableSearch');
    const table = document.getElementById('dataTable');
    const emptyState = document.getElementById('emptyState');
    
    if (searchInput && table) {
        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();
            const rows = table.getElementsByTagName('tr');
            let hasResults = false;

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                if (text.indexOf(filter) > -1) {
                    row.style.display = "";
                    hasResults = true;
                } else {
                    row.style.display = "none";
                }
            }
            
            if(emptyState) {
                if(!hasResults && filter.length > 0) {
                    table.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    table.style.display = 'table';
                    emptyState.style.display = 'none';
                }
            }
        });
    }

    // Ordenamiento
    const headers = document.querySelectorAll('th.sortable');
    headers.forEach(header => {
        header.addEventListener('click', () => {
            const tableElement = header.parentElement.parentElement.parentElement;
            const headerIndex = Array.prototype.indexOf.call(header.parentElement.children, header);
            const currentIsAscending = header.classList.contains('sort-asc');
            const type = header.getAttribute('data-type') || 'string';

            ordenarTabla(tableElement, headerIndex, !currentIsAscending, type);
            
            headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            header.classList.toggle('sort-asc', !currentIsAscending);
            header.classList.toggle('sort-desc', currentIsAscending);
        });
    });

    function ordenarTabla(table, column, asc = true, type = 'string') {
        const dirModifier = asc ? 1 : -1;
        const tBody = table.tBodies[0];
        const rows = Array.from(tBody.querySelectorAll('tr'));

        const sortedRows = rows.sort((a, b) => {
            const aCol = a.querySelector(`td:nth-child(${column + 1})`).textContent.trim();
            const bCol = b.querySelector(`td:nth-child(${column + 1})`).textContent.trim();

            if (type === 'number') return (parseFloat(aCol) - parseFloat(bCol)) * dirModifier;
            return aCol.localeCompare(bCol) * dirModifier;
        });

        while (tBody.firstChild) tBody.removeChild(tBody.firstChild);
        tBody.append(...sortedRows);
    }
});
</script>

{% endblock %}